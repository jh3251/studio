/**
 * This ruleset enforces a strict user-ownership security model for the SumBook app,
 * now with multi-store support.
 *
 * Core Philosophy:
 * All user data is private and can only be accessed by the user who created it. Data
 * is further partitioned by "stores", which are also owned by the user. A user
 * can only access data within a store they own.
 *
 * Data Structure:
 * /users/{userId}/stores/{storeId} - Stores user-created store profiles.
 * /users/{userId}/stores/{storeId}/[app_users|categories|expenses|incomes]/{docId} - All
 *   data is nested under a specific store, which is nested under the user's UID.
 *   This ensures data isolation between users and between stores.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access must be explicitly granted.
 * - Strict Ownership: A user can only access documents under their own user ID path.
 * - Store-level Isolation: All data operations (read, write) on subcollections
 *   require the request to be scoped to a path that includes a `storeId`.
 * - Data Integrity: Rules validate that the `userId` and `storeId` foreign keys in
 *   a document match the IDs in the path upon creation, and are immutable on update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for concise and readable rules
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is the owner of the document based on the path.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- User Data ---
    match /users/{userId} {
      // Users can only access their own user document.
      allow read, write: if isOwner(userId);

      // --- Stores ---
      match /stores/{storeId} {
        // A user can manage their own stores.
        allow read, list, create, update, delete: if isOwner(userId);

        // --- Store-Owned Subcollections ---
        
        // Secure a store's private list of app users.
        match /app_users/{appUserId} {
          allow read, list, create, update, delete: if isOwner(userId);
        }

        // Secure a store's private expense categories.
        match /categories/{categoryId} {
          allow read, list, create, update, delete: if isOwner(userId);
        }

        // Secure a store's private expense records.
        match /expenses/{expenseId} {
          allow read, list, create, update, delete: if isOwner(userId);
        }

        // Secure a store's private income records.
        match /incomes/{incomeId} {
           allow read, list, create, update, delete: if isOwner(userId);
        }
      }
    }
  }
}
